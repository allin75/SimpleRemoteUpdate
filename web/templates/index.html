<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>远程更新控制台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@2.0.0"></script>
  <link rel="stylesheet" href="/static/theme.css">
</head>
<body class="min-h-screen bg-slate-100 text-slate-800">
  <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-4">
    <header class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold">远程更新控制台</h1>
        <p id="runtime-summary" class="text-sm text-slate-500">服务: {{.ServiceName}} | 目录: {{.TargetDir}} | 当前版本: {{.CurrentVersion}}</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="open-self-update-btn" type="button" class="px-4 py-2 rounded border border-violet-300 text-violet-700 hover:bg-violet-50">自更新</button>
        <button id="open-system-config-btn" type="button" class="px-4 py-2 rounded border border-slate-300 hover:bg-slate-50">系统配置</button>
        <form method="post" action="/logout">
          <button class="px-4 py-2 rounded bg-slate-800 text-white hover:bg-slate-700">退出</button>
        </form>
      </div>
    </header>

    <section class="grid grid-cols-1 xl:grid-cols-[280px_1fr] gap-4">
      <aside class="bg-white rounded-xl shadow p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">程序列表</h2>
          <button id="add-project-btn" type="button" class="text-xs px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">新增</button>
        </div>
        <p class="text-xs text-slate-500">每个程序拥有独立配置，互不干扰</p>
        <div id="project-sidebar" class="space-y-2"></div>
      </aside>

      <div class="space-y-4">
        <section class="bg-white rounded-xl shadow p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-semibold">程序配置</h2>
              <p id="active-project-title" class="text-xs text-slate-500">未选择程序</p>
            </div>
            <button id="delete-project-btn" type="button" class="text-xs px-2 py-1 rounded border border-rose-300 text-rose-700 hover:bg-rose-50">删除当前程序</button>
          </div>
          <form id="project-form" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
            <label class="block text-sm">
              project_id
              <input name="project_id" readonly class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono opacity-80" />
            </label>
            <label class="block text-sm">
              name
              <input name="name" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
            </label>
            <label class="block text-sm">
              current_version
              <input name="current_version" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
            </label>
            <label class="block text-sm">
              service_name
              <input name="service_name" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
              <span class="mt-1 block text-xs text-slate-500">可留空；留空时部署/回滚仅替换文件，不控制服务启停</span>
            </label>
            <label class="block text-sm md:col-span-2">
              target_dir
              <input name="target_dir" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono" />
            </label>
            <label class="block text-sm">
              max_upload_mb
              <input name="max_upload_mb" type="number" min="1" step="1" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
            </label>
            <label class="block text-sm">
              default_replace_mode
              <select name="default_replace_mode" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm">
                <option value="full">full（全部替换，会删除目标目录中上传包不存在的文件）</option>
                <option value="partial">partial（局部替换，只覆盖上传包内文件）</option>
              </select>
            </label>
            <label class="block text-sm md:col-span-2 xl:col-span-3">
              <span class="inline-flex items-center">
                backup_ignore_text（每行一个忽略规则）
                <span
                  class="ml-1 inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-400 text-[10px] text-slate-500 cursor-help"
                  title="写法示例：&#10;appsettings.json  -> 忽略根目录文件&#10;logs/  -> 忽略整个目录&#10;*.log  -> 忽略任意 .log 文件&#10;configs/*.json  -> 忽略指定目录匹配文件&#10;说明：每行一条规则，不支持 ** 通配符">?</span>
              </span>
              <textarea name="backup_ignore_text" rows="4" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono"></textarea>
            </label>
            <label class="block text-sm md:col-span-2 xl:col-span-3">
              <span class="inline-flex items-center">
                replace_ignore_text（替换忽略，每行一个；更新和回滚都生效）
                <span
                  class="ml-1 inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-400 text-[10px] text-slate-500 cursor-help"
                  title="写法示例：&#10;appsettings.json  -> 忽略根目录文件&#10;logs/  -> 忽略整个目录&#10;*.log  -> 忽略任意 .log 文件&#10;configs/*.json  -> 忽略指定目录匹配文件&#10;说明：每行一条规则，不支持 ** 通配符">?</span>
              </span>
              <textarea name="replace_ignore_text" rows="4" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono"></textarea>
            </label>
            <label class="inline-flex items-center gap-2 text-sm md:col-span-2 xl:col-span-3">
              <input name="set_default_project" type="checkbox" class="rounded border border-slate-300" />
              保存后设为默认程序
            </label>
            <div class="md:col-span-2 xl:col-span-3 flex items-center gap-3">
              <button type="submit" class="px-4 py-2 rounded bg-sky-700 text-white hover:bg-sky-600">保存当前程序配置</button>
              <span id="project-message" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </section>

      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="text-lg font-semibold">上传部署包</h2>
        <form id="upload-form" class="space-y-3">
          <label class="block text-sm">
            选择程序
            <select id="project-select" name="project_id"
                    class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300 bg-white"></select>
          </label>
          <label class="block text-sm">
            ZIP 包（最大 <span id="max-upload-label">{{.MaxUploadMB}}</span> MB）
            <input type="file" name="package" accept=".zip" required
                   class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300 bg-white" />
          </label>
          <label class="block text-sm">
            目标版本（可选，不填则自动取下一版本）
            <input id="target-version-input" name="target_version" placeholder="例如 0.1.1 或留空自动递增"
                   class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300 bg-white" />
            <span id="next-version-label" class="mt-1 block text-xs text-slate-500">默认下一版本: -</span>
          </label>
          <label class="block text-sm">
            本次替换模式
            <select id="upload-replace-mode" name="replace_mode"
                    class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300 bg-white">
              <option value="full">full（全部替换）</option>
              <option value="partial">partial（局部替换）</option>
            </select>
            <span class="mt-1 block text-xs text-slate-500">可按本次发布切换；局部替换不会删除目标目录已有文件</span>
          </label>
          <label class="block text-sm">
            更新说明（可编辑）
            <textarea name="note" rows="3" class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300"></textarea>
          </label>
          <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500">开始上传并部署</button>
        </form>

        <div class="space-y-1">
          <div class="flex justify-between text-xs text-slate-500">
            <span>上传进度</span>
            <span id="upload-progress-label">0%</span>
          </div>
          <div class="h-2 rounded bg-slate-200 overflow-hidden">
            <div id="upload-progress-bar" class="h-full w-0 bg-emerald-500 transition-all"></div>
          </div>
          <p id="upload-message" class="text-sm text-slate-600"></p>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">实时日志</h2>
          <span id="log-deployment-id" class="text-xs text-slate-500"></span>
        </div>
        <div class="space-y-1">
          <div class="flex justify-between text-xs text-slate-500">
            <span id="log-stage-label">阶段: -</span>
            <span id="log-stage-progress-label">-</span>
          </div>
          <div class="h-2 rounded bg-slate-200 overflow-hidden">
            <div id="log-stage-progress-bar" class="h-full w-0 bg-sky-500 transition-all"></div>
          </div>
        </div>
        <div id="log-panel" class="mt-3 h-72 overflow-auto rounded bg-slate-950 text-slate-100 text-xs p-3 font-mono"></div>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">部署记录</h2>
        <button onclick="window.refreshDeployments()" class="text-sm px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50">刷新</button>
      </div>
      <div id="deployments-container"
           class="mt-3"
           hx-get="/partials/deployments?offset=0&limit=20"
           hx-trigger="load"
           hx-swap="innerHTML">
      </div>
    </section>
  </div>

  <dialog id="project-create-dialog" class="w-[min(760px,96vw)] rounded-xl border border-slate-300 bg-white p-0">
    <div class="p-4 border-b border-slate-300 flex items-center justify-between">
      <h3 class="text-base font-semibold">新增程序</h3>
      <button id="project-create-cancel" class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-100">关闭</button>
    </div>
    <form id="project-create-form" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <label class="block text-sm">
        id（可选，不填自动生成）
        <input name="id" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono" />
      </label>
      <label class="block text-sm">
        name
        <input name="name" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        service_name
        <input name="service_name" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
        <span class="mt-1 block text-xs text-slate-500">可留空；留空时部署/回滚仅替换文件，不控制服务启停</span>
      </label>
      <label class="block text-sm md:col-span-2">
        target_dir
        <input name="target_dir" required class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono" />
      </label>
      <label class="block text-sm">
        current_version
        <input name="current_version" value="0.0.1" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        max_upload_mb
        <input name="max_upload_mb" type="number" min="1" step="1" value="1024" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        default_replace_mode
        <select name="default_replace_mode" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm">
          <option value="full">full（全部替换）</option>
          <option value="partial">partial（局部替换）</option>
        </select>
      </label>
      <label class="block text-sm md:col-span-2">
        <span class="inline-flex items-center">
          backup_ignore_text（每行一个）
          <span
            class="ml-1 inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-400 text-[10px] text-slate-500 cursor-help"
            title="写法示例：&#10;appsettings.json  -> 忽略根目录文件&#10;logs/  -> 忽略整个目录&#10;*.log  -> 忽略任意 .log 文件&#10;configs/*.json  -> 忽略指定目录匹配文件&#10;说明：每行一条规则，不支持 ** 通配符">?</span>
        </span>
        <textarea name="backup_ignore_text" rows="3" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono"></textarea>
      </label>
      <label class="block text-sm md:col-span-2">
        <span class="inline-flex items-center">
          replace_ignore_text（每行一个）
          <span
            class="ml-1 inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-400 text-[10px] text-slate-500 cursor-help"
            title="写法示例：&#10;appsettings.json  -> 忽略根目录文件&#10;logs/  -> 忽略整个目录&#10;*.log  -> 忽略任意 .log 文件&#10;configs/*.json  -> 忽略指定目录匹配文件&#10;说明：每行一条规则，不支持 ** 通配符">?</span>
        </span>
        <textarea name="replace_ignore_text" rows="3" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm font-mono"></textarea>
      </label>
      <label class="inline-flex items-center gap-2 text-sm md:col-span-2">
        <input name="set_default_project" type="checkbox" class="rounded border border-slate-300" />
        创建后设为默认程序
      </label>
      <div class="md:col-span-2 flex items-center gap-3">
        <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500">创建程序</button>
        <span id="project-create-message" class="text-sm text-slate-600"></span>
      </div>
    </form>
  </dialog>

  <dialog id="system-config-dialog" class="w-[min(1100px,96vw)] rounded-xl border border-slate-300 bg-white p-0">
    <div class="p-4 border-b border-slate-300 flex items-center justify-between">
      <div>
        <h3 class="text-base font-semibold">系统配置</h3>
        <p class="text-xs text-slate-500">登录密钥/监听地址/存储路径等共用配置</p>
      </div>
      <button id="system-config-close" type="button" class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-100">关闭</button>
    </div>
    <form id="system-form" class="p-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
      <label class="block text-sm">
        listen_addr
        <input name="listen_addr" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        session_cookie
        <input name="session_cookie" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        default_project_id
        <select id="default-project-select" name="default_project_id" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm"></select>
      </label>
      <label class="block text-sm">
        upload_dir
        <input name="upload_dir" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        work_dir
        <input name="work_dir" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        backup_dir
        <input name="backup_dir" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        deployments_file
        <input name="deployments_file" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm">
        log_file
        <input name="log_file" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <label class="block text-sm md:col-span-2 xl:col-span-3">
        new_auth_key（可选，填写后会更新登录密钥）
        <input name="new_auth_key" type="password" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
      </label>
      <div class="md:col-span-2 xl:col-span-3 flex items-center gap-3">
        <button type="submit" class="px-4 py-2 rounded bg-sky-700 text-white hover:bg-sky-600">保存系统配置</button>
        <span id="system-message" class="text-sm text-slate-600"></span>
      </div>
    </form>
  </dialog>

  <dialog id="self-update-dialog" class="w-[min(780px,96vw)] rounded-xl border border-slate-300 bg-white p-0">
    <div class="p-4 border-b border-slate-300 flex items-center justify-between">
      <div>
        <h3 class="text-base font-semibold">SimpleRemoteUpdate 自更新</h3>
        <p class="text-xs text-slate-500">上传新的 updater.exe，自动替换并重启当前程序</p>
      </div>
      <button id="self-update-close" type="button" class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-100">关闭</button>
    </div>
    <div class="p-4 space-y-3">
      <form id="self-update-form" class="space-y-3">
        <label class="block text-sm">
          新版本 EXE（仅 `updater.exe`）
          <input type="file" name="package" accept=".exe" required
                 class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300 bg-white" />
        </label>
        <label class="block text-sm">
          目标版本（可选）
          <input name="target_version" placeholder="例如 0.1.3"
                 class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300 bg-white" />
        </label>
        <label class="block text-sm">
          更新说明（可选）
          <textarea name="note" rows="2" class="mt-1 block w-full text-sm border rounded px-3 py-2 border-slate-300"></textarea>
        </label>
        <button type="submit" class="px-4 py-2 rounded bg-violet-700 text-white hover:bg-violet-600">上传并自更新</button>
        <p class="text-xs text-slate-500">执行后当前进程会自动退出并重启，页面可能短暂断开。</p>
      </form>

      <div class="space-y-1">
        <div class="flex justify-between text-xs text-slate-500">
          <span>自更新上传进度</span>
          <span id="self-update-progress-label">0%</span>
        </div>
        <div class="h-2 rounded bg-slate-200 overflow-hidden">
          <div id="self-update-progress-bar" class="h-full w-0 bg-violet-500 transition-all"></div>
        </div>
        <p id="self-update-message" class="text-sm text-slate-600"></p>
      </div>
    </div>
  </dialog>

  <dialog id="changes-dialog" class="w-[min(980px,96vw)] rounded-xl border border-slate-300 bg-white p-0">
    <div class="p-4 border-b border-slate-300 flex items-center justify-between">
      <div>
        <h3 id="changes-dialog-title" class="text-base font-semibold">变更明细</h3>
        <p id="changes-dialog-subtitle" class="text-xs text-slate-500"></p>
      </div>
      <button id="changes-dialog-close" class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-100">关闭</button>
    </div>
    <div class="p-4 space-y-4">
      <section>
        <h4 class="text-sm font-semibold mb-2">替换忽略规则</h4>
        <div id="changes-ignore-list" class="max-h-36 overflow-auto rounded border border-slate-300 p-2 text-xs font-mono bg-slate-50"></div>
      </section>
      <section>
        <h4 class="text-sm font-semibold mb-2">忽略命中路径</h4>
        <div id="changes-ignored-paths" class="max-h-32 overflow-auto rounded border border-slate-300 p-2 text-xs font-mono bg-slate-50"></div>
      </section>
      <section>
        <h4 class="text-sm font-semibold mb-2">文件变更明细</h4>
        <div class="max-h-[46vh] overflow-auto rounded border border-slate-300">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b bg-slate-50">
                <th class="px-2 py-2 text-left">动作</th>
                <th class="px-2 py-2 text-left">文件</th>
                <th class="px-2 py-2 text-left">大小</th>
              </tr>
            </thead>
            <tbody id="changes-file-body"></tbody>
          </table>
        </div>
      </section>
      <div id="changes-preview-actions" class="hidden border-t border-slate-200 pt-3 flex items-center justify-end gap-2">
        <span id="changes-preview-hint" class="mr-auto text-xs text-amber-700"></span>
        <button id="changes-preview-cancel" type="button" class="px-3 py-1.5 rounded border border-slate-300 text-sm hover:bg-slate-100">取消</button>
        <button id="changes-preview-confirm" type="button" class="px-3 py-1.5 rounded bg-emerald-600 text-white text-sm hover:bg-emerald-500">确认部署</button>
      </div>
    </div>
  </dialog>

  <script src="/static/app.js"></script>
</body>
</html>
